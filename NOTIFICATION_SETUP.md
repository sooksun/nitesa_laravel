# ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (Notification System)

## üìß ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô

‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏¥‡πÄ‡∏ó‡∏® NITESA ‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡πà‡∏≤‡∏ô Email ‡πÅ‡∏•‡∏∞ Database (in-app notification) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô:

### ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô

1. **‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥** (`SupervisionSubmittedNotification`)
   - ‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á: ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ (EXECUTIVE) ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (ADMIN)
   - ‡πÄ‡∏°‡∏∑‡πà‡∏≠: ‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏Å‡πå‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥

2. **‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡∏¥‡πÄ‡∏ó‡∏®** (`SupervisionApprovedNotification`)
   - ‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á: ‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏Å‡πå‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏¥‡πÄ‡∏ó‡∏®
   - ‡πÄ‡∏°‡∏∑‡πà‡∏≠: ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡∏¥‡πÄ‡∏ó‡∏®

3. **‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç** (`SupervisionRejectedNotification`)
   - ‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á: ‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏Å‡πå‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏¥‡πÄ‡∏ó‡∏®
   - ‡πÄ‡∏°‡∏∑‡πà‡∏≠: ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á

4. **‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏Å‡∏≤‡∏£‡∏ô‡∏¥‡πÄ‡∏ó‡∏®** (`SupervisionPublishedNotification`)
   - ‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á: ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ô‡∏¥‡πÄ‡∏ó‡∏® ‡πÅ‡∏•‡∏∞‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏Å‡πå
   - ‡πÄ‡∏°‡∏∑‡πà‡∏≠: ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏Å‡∏≤‡∏£‡∏ô‡∏¥‡πÄ‡∏ó‡∏®

---

## üöÄ ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á

### 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Notifications Table

```bash
php artisan migrate
```

### 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Jobs Table (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Queue)

```bash
php artisan queue:table
php artisan migrate
```

### 3. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Mail Configuration

#### ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å A: ‡πÉ‡∏ä‡πâ Gmail (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞ Production ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å)

1. ‡∏™‡∏£‡πâ‡∏≤‡∏á App-Specific Password:
   - ‡πÑ‡∏õ‡∏ó‡∏µ‡πà https://myaccount.google.com/apppasswords
   - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "Mail" ‡πÅ‡∏•‡∏∞ "Other (Custom name)"
   - ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å password ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ

2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏ü‡∏•‡πå `.env`:
   ```env
   MAIL_MAILER=smtp
   MAIL_HOST=smtp.gmail.com
   MAIL_PORT=587
   MAIL_USERNAME=your-email@gmail.com
   MAIL_PASSWORD=your-app-specific-password
   MAIL_ENCRYPTION=tls
   MAIL_FROM_ADDRESS="noreply@nitesa.go.th"
   MAIL_FROM_NAME="‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏¥‡πÄ‡∏ó‡∏® NITESA"
   ```

#### ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å B: ‡πÉ‡∏ä‡πâ SendGrid (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Production)

1. ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ SendGrid: https://sendgrid.com/
2. ‡∏™‡∏£‡πâ‡∏≤‡∏á API Key
3. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏ü‡∏•‡πå `.env`:
   ```env
   MAIL_MAILER=smtp
   MAIL_HOST=smtp.sendgrid.net
   MAIL_PORT=587
   MAIL_USERNAME=apikey
   MAIL_PASSWORD=your-sendgrid-api-key
   MAIL_ENCRYPTION=tls
   MAIL_FROM_ADDRESS="noreply@nitesa.go.th"
   MAIL_FROM_NAME="‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏¥‡πÄ‡∏ó‡∏® NITESA"
   ```

#### ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å C: ‡πÉ‡∏ä‡πâ Mailpit (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö Local)

Mailpit ‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö Laravel Herd/Valet/Homestead:
```env
MAIL_MAILER=smtp
MAIL_HOST=127.0.0.1
MAIL_PORT=1025
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_ENCRYPTION=null
```

‡πÄ‡∏õ‡∏¥‡∏î Mailpit UI: http://localhost:8025

### 4. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Queue Connection

‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏ü‡∏•‡πå `.env`:
```env
QUEUE_CONNECTION=database
```

### 5. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Queue Worker

#### Development:
```bash
php artisan queue:work
```

#### Production (Supervisor):
‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå `/etc/supervisor/conf.d/nitesa-worker.conf`:
```ini
[program:nitesa-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /path/to/nitesa2/artisan queue:work --sleep=3 --tries=3 --max-time=3600
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/path/to/nitesa2/storage/logs/worker.log
stopwaitsecs=3600
```

‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô:
```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start nitesa-worker:*
```

---

## üì± ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° SMS Notification (Optional)

### ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å A: Vonage (Nexmo)

1. ‡∏™‡∏°‡∏±‡∏Ñ‡∏£: https://www.vonage.com/
2. ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á package:
   ```bash
   composer require laravel/vonage-notification-channel
   ```
3. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç `.env`:
   ```env
   VONAGE_KEY=your-api-key
   VONAGE_SECRET=your-api-secret
   VONAGE_SMS_FROM=NITESA
   ```
4. ‡πÄ‡∏û‡∏¥‡πà‡∏° `phone` field ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á `user`
5. Uncomment SMS channel ‡πÉ‡∏ô notification classes

### ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å B: Twilio

1. ‡∏™‡∏°‡∏±‡∏Ñ‡∏£: https://www.twilio.com/
2. ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á package:
   ```bash
   composer require twilio/sdk
   ```
3. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç `.env`:
   ```env
   TWILIO_SID=your-account-sid
   TWILIO_TOKEN=your-auth-token
   TWILIO_FROM=+1234567890
   ```

---

## üß™ ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö Notification

### ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏á Email:

```bash
php artisan tinker
```

```php
$user = App\Models\User::first();
$supervision = App\Models\Supervision::first();

// ‡∏ó‡∏î‡∏™‡∏≠‡∏ö SupervisionSubmittedNotification
$user->notify(new App\Notifications\SupervisionSubmittedNotification($supervision));

// ‡∏ó‡∏î‡∏™‡∏≠‡∏ö SupervisionApprovedNotification
$user->notify(new App\Notifications\SupervisionApprovedNotification($supervision, '‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö'));

// ‡∏ó‡∏î‡∏™‡∏≠‡∏ö SupervisionRejectedNotification
$user->notify(new App\Notifications\SupervisionRejectedNotification($supervision, '‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö', '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö'));

// ‡∏ó‡∏î‡∏™‡∏≠‡∏ö SupervisionPublishedNotification
$user->notify(new App\Notifications\SupervisionPublishedNotification($supervision));
```

### ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Queue Jobs:

```bash
# ‡∏î‡∏π jobs ‡πÉ‡∏ô queue
php artisan queue:monitor

# ‡∏î‡∏π failed jobs
php artisan queue:failed

# Retry failed job
php artisan queue:retry {job-id}

# Retry all failed jobs
php artisan queue:retry all
```

---

## üîß Troubleshooting

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: Email ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á

1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Queue Worker ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà:
   ```bash
   ps aux | grep queue:work
   ```

2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö logs:
   ```bash
   tail -f storage/logs/laravel.log
   ```

3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö mail configuration:
   ```bash
   php artisan config:clear
   php artisan cache:clear
   ```

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: Queue Jobs ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô

1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö `QUEUE_CONNECTION` ‡πÉ‡∏ô `.env`
2. Run migration ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö jobs table
3. Restart queue worker:
   ```bash
   php artisan queue:restart
   ```

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: Gmail ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠

1. ‡πÄ‡∏õ‡∏¥‡∏î "Less secure app access" ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ App-Specific Password
2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö 2FA settings
3. ‡∏•‡∏≠‡∏á port 465 (SSL) ‡πÅ‡∏ó‡∏ô 587 (TLS)

---

## üìä Database Notifications (In-App)

Notifications ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á `notifications` ‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô UI ‡πÑ‡∏î‡πâ:

### ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Notifications:

```php
// ‡∏î‡∏∂‡∏á unread notifications
$notifications = auth()->user()->unreadNotifications;

// ‡∏î‡∏∂‡∏á all notifications
$notifications = auth()->user()->notifications;

// Mark as read
$notification->markAsRead();

// Mark all as read
auth()->user()->unreadNotifications->markAsRead();
```

### ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Blade Template:

```blade
@if(auth()->user()->unreadNotifications->count() > 0)
    <div class="notifications">
        <span class="badge">{{ auth()->user()->unreadNotifications->count() }}</span>
        
        @foreach(auth()->user()->unreadNotifications as $notification)
            <div class="notification-item">
                <p>{{ $notification->data['message'] }}</p>
                <a href="{{ $notification->data['url'] }}">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</a>
            </div>
        @endforeach
    </div>
@endif
```

---

## üéØ Best Practices

1. **‡πÉ‡∏ä‡πâ Queue ‡πÄ‡∏™‡∏°‡∏≠** - Notifications ‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô background ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ user ‡∏£‡∏≠
2. **Graceful Degradation** - ‡∏ñ‡πâ‡∏≤ email ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ
3. **Rate Limiting** - ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô emails ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
4. **Monitoring** - ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° failed jobs ‡πÅ‡∏•‡∏∞ email delivery rate
5. **Testing** - ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å notification ‡∏Å‡πà‡∏≠‡∏ô deploy
6. **Unsubscribe Option** - ‡πÉ‡∏´‡πâ users ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö notification ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏´‡∏ô

---

## üìö ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°

- [Laravel Notifications](https://laravel.com/docs/10.x/notifications)
- [Laravel Queues](https://laravel.com/docs/10.x/queues)
- [Laravel Mail](https://laravel.com/docs/10.x/mail)
- [Supervisor Documentation](http://supervisord.org/)

---

## üÜò ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô

‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏™‡∏á‡∏™‡∏±‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:
- Email: support@nitesa.go.th
- GitHub Issues: [repository-url]
